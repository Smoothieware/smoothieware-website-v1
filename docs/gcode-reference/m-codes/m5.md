---
permalink: /m5
---

# {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} G-code

{::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} stops the spindle's rotation.

### What is a Spindle?

A spindle is a controlled motor that turns a tool (such as an endmill) at a given speed to allow it to remove material from the workpiece.

This is commonly used in CNC milling operations.

### Related Commands

{::nomarkdown}<mcode>M5</mcode>{:/nomarkdown}'s counterpart is the [{::nomarkdown}<mcode>M3</mcode>{:/nomarkdown}](m3) command which is used to start the spindle and specify its rotation speed.



In V1, there are additional spindle-related commands:

- [{::nomarkdown}<mcode>M4</mcode>{:/nomarkdown}](m4) - Start spindle in reverse direction
- [{::nomarkdown}<mcode>M957</mcode>{:/nomarkdown}](m957) - Report current spindle speed and PWM value
- [{::nomarkdown}<mcode>M958</mcode>{:/nomarkdown}](m958) - Report or set PID control parameters



{::nomarkdown}
<sl-alert variant="neutral" open>
  <sl-icon slot="icon" name="info-circle"></sl-icon>
  <strong>Safety Note:</strong> Always use <mcode>M5</mcode> to stop the spindle before changing tools or when the job is complete.
</sl-alert>
{:/nomarkdown}

## Format

The command is used as such:

```gcode
M5
```

Which means: stop the spindle's rotation.

## Parameters

The {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} command requires no parameters.

It simply stops the spindle regardless of its current speed.



## Behavior

{::nomarkdown}
<versioned orientation="vertical">
<v1>
{:/nomarkdown}

**Smoothieware V1:**
- Implemented in `SpindleControl` module
- Waits for motion queue to empty before executing to ensure safe synchronization
- Stores speed as 0 in modal state tracking
- Only turns off spindle if it's currently running (prevents redundant operations)
- Speed value from the last {::nomarkdown}<mcode>M3</mcode>{:/nomarkdown} command is retained in memory for reuse on next spindle-on command

{::nomarkdown}
</v1>
<v2>
{:/nomarkdown}

**Smoothieware V2:**
- Handled via Switch module (not SpindleControl module)
- Drains motion queue before execution
- Sets switch state to off using the configured off-state PWM or digital value
- Uses simplified configuration compared to V1

{::nomarkdown}
</v2>
</versioned>

{:/nomarkdown}

## Configuration

{::nomarkdown}
<versioned orientation="vertical">
<v1>
{:/nomarkdown}

The spindle functionality of Smoothie V1 is configured via the [Spindle module](spindle-module).

### V1 Required Setup

Before using {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown}, ensure you have:

- Enabled the spindle module in your configuration
- Configured the appropriate pin for spindle control (PWM-capable pin)
- Tested that {::nomarkdown}<mcode>M3</mcode>{:/nomarkdown} works correctly ({::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} uses the same configuration)

The spindle module supports three control types:

- **PWM**: Direct PWM control with optional PID closed-loop feedback
- **Analog**: 0-10V analog signal for VFDs (Variable Frequency Drives)
- **Modbus**: RS485 communication for advanced VFD control

### V1 PWM Spindle Example

```config
spindle.enable                    true
spindle.type                      pwm
spindle.pwm_pin                   2.4
spindle.pwm_period                1000
spindle.max_pwm                   1.0
spindle.default_rpm               5000
```

See [Spindle module documentation](spindle-module) for detailed configuration of all control types.

{::nomarkdown}
</v1>
<v2>
{:/nomarkdown}

The spindle functionality of Smoothie V2 is configured via the Switch module.

### V2 Basic Setup

Before using {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown}, ensure you have:

- Enabled spindle control in your configuration
- Configured the appropriate output pin (STM32 format: PXn, e.g., <pin>PA5</pin>)
- Set the spindle speed parameters

Note: V2 configuration uses STM32H7xx pin notation (e.g., <pin>PA5</pin>, <pin>PB12</pin>) instead of LPC1769 format (e.g., 2.4).

{::nomarkdown}
</v2>
</versioned>
{:/nomarkdown}



## Additional Information

### Speed Memory

The last set speed value (from {::nomarkdown}<mcode>M3</mcode>{:/nomarkdown}) is retained in memory even after {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} is executed. When the spindle is turned on again without an `S` parameter, it will use this retained speed value.

### Queue Synchronization

The {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} command waits for the motion queue to empty before execution. This ensures that all pending movements complete before the spindle stops, maintaining proper timing and coordination.

### Emergency Stop Behavior

- {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} is automatically issued when {::nomarkdown}<mcode>M112</mcode>{:/nomarkdown} (emergency stop) is triggered
- When the program ends ({::nomarkdown}<mcode>M2</mcode>{:/nomarkdown}/{::nomarkdown}<mcode>M30</mcode>{:/nomarkdown} in GRBL mode), {::nomarkdown}<mcode>M5</mcode>{:/nomarkdown} is automatically issued to safely stop the spindle

### Typical G-code Pattern

```gcode
G21             ; Metric units
G90             ; Absolute positioning
G28             ; Home all axes
M3 S12000       ; Start spindle at 12000 RPM

; ... milling operations ...

M5              ; Stop spindle when done
G28             ; Home all axes
M2              ; End program
```



## Further reading

These resources are used as references for Gcode:

- [LinuxCNC Gcode list](http://linuxcnc.org/docs/html/gcode.html)
- [Reprap Gcode list](http://reprap.org/wiki/G-code)
